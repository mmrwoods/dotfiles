#!/bin/bash

export TERM='xterm-color'
export CLICOLOR=1
export LSCOLORS=ExFxCxDxBxEgedabagacad
export PATH=$PATH:$HOME/bin

export EDITOR=vim

export NODE_PATH=/usr/local/lib/node_modules

# Bash specific, i.e. not bourne shell compatible stuff goes here.
# Allows file be sourced from .profile, without causing problems
# when sudo is configured to keep the HOME env variable and target
# user's shell is bourne compatible, but not bash.
if [ $SHELL = '/bin/bash' ]; then

  # bash-completion for OSX
  if [ `which brew` ] && [ -r `brew --prefix`/etc/bash_completion ]; then
    # homebrew
    source `brew --prefix`/etc/bash_completion
  elif [ -f /opt/local/etc/bash_completion ]; then
    # macports
    source /opt/local/etc/bash_completion
  fi

  # git completion and prompt
  type __git_ps1 >& /dev/null
  if [ $? -ne 0 ]; then
    source ~/dotfiles/bash/git-completion.sh
  fi

  # rails command completion
  source ~/dotfiles/bash/rails.bash

  # rvm command completion
  if [ -r ~/.rvm/scripts/completion ]; then
    source ~/.rvm/scripts/completion
  fi

  GIT_PS1_SHOWDIRTYSTATE=1
  PS1='\w$(__git_ps1 "[%s]")\$ '

  # if some kind of xterm, use prompt command to set window title
  if [ "${TERM%%-*}" == xterm ]; then
    PROMPT_COMMAND='echo -ne "\033]0;${PWD/#$HOME/~}\007"'
  fi

  # quick hack to create aliases for starting and stopping postgres
  if [ `which brew` ] && [ -r `brew --prefix`/var/postgres ]; then
    alias pg_start="pg_ctl -D $(brew --prefix)/var/postgres -l /usr/local/var/postgres/server.log start"
    alias pg_stop="pg_ctl -D $(brew --prefix)/var/postgres stop -s -m fast"
  fi

  # use macvim's huge vim with ruby support on osx - https://github.com/mxcl/homebrew/issues/5148
  if [ `which brew` ]; then
    macvim_version=`brew list --versions macvim | sed 's/.* \([0-9\.\-]*\)$/\1/'`
    if [ -n "${macvim_version}" ]; then
      alias vim=`brew --prefix`/Cellar/macvim/${macvim_version}/MacVim.app/Contents/MacOS/Vim
    fi
  fi

  # hack ssh completion, which for some bizarre reason fails when a host alias begins with t (no, I haven't figured out why yet)
  if [ -f ~/.ssh/config ]; then
    complete -W "$(echo `fgrep "Host " ~/.ssh/config | cut -f 2 -d ' '`)" ssh
  fi

fi

# add /usr/local/sbin to path if necessary
if [ ! `echo $PATH | grep /usr/local/sbin` ]; then
  PATH=$PATH:/usr/local/sbin
fi

# use gnome-open rather than openvt
if [ `which gnome-open` ]; then
  alias open="gnome-open"
fi

# because I keep forgetting how to do it in Linux
if [ ! `which pbcopy` ] && [ `which xclip` ]; then
  alias pbcopy="xclip -selection clipboard"
  alias pbpaste="xclip -o -selection clipboard"
fi

set -o vi

alias hs='history'

alias egrep='egrep --color=auto --exclude=tags'
alias fgrep='fgrep --color=auto --exclude=tags'
alias grep='grep --color=auto --exclude=tags'

alias b='bundle'
alias bi='bundle install'
alias be='bundle exec'

alias c='bundle exec cucumber -r features'
alias cw='bundle exec cucumber -r features -p wip'
alias cq='bundle exec cucumber -r features --tags ~@javascript --tags ~@slow'
alias cj='bundle exec cucumber -r features --tags @javascript'
alias r='bundle exec rspec spec'

alias sc='spring cucumber -r features'
alias scw='spring cucumber -r features -p wip'
alias scq='spring cucumber -r features --tags ~@javascript --tags ~@slow'
alias scj='spring cucumber -r features --tags @javascript'
alias sr='spring rspec spec'

if [ -f /usr/local/bin/ctags ]; then
  alias ctags='/usr/local/bin/ctags'
fi

# make random password
function mkpw() { head /dev/urandom | uuencode -m - | sed -n 2p | cut -c1-${1:-8} | tr -d '\n'; }

# what is my ip again?
function whatismyip() { curl -s http://icanhazip.com/ ; }

# current gems dir (works with rvm and bundler)
gems() {
  bundle config > /dev/null
  eval $(
    if [ $? -eq 0 ]; then
      echo "bundle exec "
    fi
    echo "ruby -r rubygems -e 'puts Gem.path.detect{|d| not d.include?(\".gem\") }'"
  )
}
