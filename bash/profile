#!/bin/bash

export TERM='xterm-color'
export CLICOLOR=1
export LSCOLORS=gxfxbEaEBxxEhEhBaDaCaD
export PATH=$PATH:$HOME/bin

export EDITOR=vim

export NODE_PATH=/usr/local/lib/node_modules

export CUCUMBER_COLORS=comment=cyan

# check if homebrew is installed and update path such that
# homebrew binaries take precedence over system binaries
if which brew &> /dev/null; then
  has_brew=true
  brew_prefix=`brew --prefix`
  export PATH=$brew_prefix/bin:$brew_prefix/sbin:$PATH
fi

# Bash specific, i.e. not bourne shell compatible stuff goes here.
# Allows file be sourced from .profile, without causing problems
# when sudo is configured to keep the HOME env variable and target
# user's shell is bourne compatible, but not bash.
if [ $SHELL = '/bin/bash' ]; then

  # bash completion
  if [ $has_brew ] && [ -r $brew_prefix/etc/bash_completion ]; then
    source $brew_prefix/etc/bash_completion
  fi

  # git completion
  if ! type __git_ps1 &> /dev/null; then
    source ~/dotfiles/bash/git-completion.sh
  fi

  # rails command completion
  # TODO: try https://github.com/mernen/completion-ruby
  if [ ${BASH_VERSINFO[0]} -ge 4 ]; then
    source ~/dotfiles/bash/rails.bash
  fi

  # rvm command completion
  if [ -r $rvm_path/scripts/completion ]; then
    source $rvm_path/scripts/completion
  fi

  # git prompt
  GIT_PS1_SHOWDIRTYSTATE=1
  PS1='\w$(__git_ps1 "[%s]")\$ '

  # if some kind of xterm, use prompt command to set window title
  if [ "${TERM%%-*}" == xterm ]; then
    PROMPT_COMMAND='echo -ne "\033]0;${PWD/#$HOME/~}\007"'
  fi

  # quick hack to create aliases for starting and stopping postgres
  if [ $has_brew ] && [ -r $brew_prefix/var/postgres ]; then
    alias pg_start="pg_ctl -D $brew_prefix/var/postgres -l $brew_prefix/var/postgres/server.log start"
    alias pg_stop="pg_ctl -D $brew_prefix/var/postgres stop -s -m fast"
  fi

  # use macvim's huge vim with ruby support on osx unless vim installed separately via homebrew
  # see https://github.com/mxcl/homebrew/issues/5148
  if [ $has_brew ] && [ ! -r $brew_prefix/bin/vim ]; then
    macvim_version=`brew list --versions macvim | sed 's/.* \([0-9\.\-]*\)$/\1/'`
    if [ -n "${macvim_version}" ]; then
      alias vim=$brew_prefix/Cellar/macvim/$macvim_version/MacVim.app/Contents/MacOS/Vim
    fi
  fi

  # hack ssh completion, which for some bizarre reason fails when a host alias begins with t (no, I haven't figured out why yet)
  if [ -f ~/.ssh/config ]; then
    complete -W "$(echo `fgrep "Host " ~/.ssh/config | cut -f 2 -d ' '`)" ssh
  fi

  # reload bash shell (I always forget how)
  alias reload="exec bash -l"

fi

# add /usr/local/sbin to path if necessary
if ! echo $PATH | grep /usr/local/sbin &> /dev/null; then
  PATH=$PATH:/usr/local/sbin
fi

# use gnome-open rather than openvt
if which gnome-open &> /dev/null; then
  alias open="gnome-open"
fi

# because I keep forgetting how to do it in Linux
if ! which pbcopy &> /dev/null && which xclip &> /dev/null; then
  alias pbcopy="xclip -selection clipboard"
  alias pbpaste="xclip -o -selection clipboard"
fi

# vi keyboard shortcuts
set -o vi

alias h='history'
alias hs='history'

alias egrep='egrep --color=auto --exclude=tags'
alias fgrep='fgrep --color=auto --exclude=tags'
alias grep='grep --color=auto --exclude=tags'

alias b='bundle'
alias bi='bundle install'
alias be='bundle exec'

alias c='bundle exec cucumber -r features'
alias cw='bundle exec cucumber -r features -p wip'
alias cq='bundle exec cucumber -r features --tags ~@javascript --tags ~@slow'
alias cj='bundle exec cucumber -r features --tags @javascript'
alias r='bundle exec rspec spec'
alias rw='bundle exec rspec spec --tag wip'

alias sc='spring cucumber -r features'
alias scw='spring cucumber -r features -p wip'
alias scq='spring cucumber -r features --tags ~@javascript --tags ~@slow'
alias scj='spring cucumber -r features --tags @javascript'
alias sr='spring rspec spec'
alias srw='spring rspec spec --tag wip'

if [ -f /usr/local/bin/ctags ]; then
  alias ctags='/usr/local/bin/ctags'
fi

# make random password
mkpw() { head /dev/urandom | uuencode -m - | sed -n 2p | cut -c1-${1:-20} | tr -d '\n'; }

# what is my ip again?
whatismyip() { curl -s http://icanhazip.com/ ; }

# current gems dir (works with rvm and bundler)
gems() {
  bundle config > /dev/null
  eval $(
    if [ $? -eq 0 ]; then
      echo "bundle exec "
    fi
    echo "ruby -r rubygems -e 'puts Gem.path.detect{|d| not d.include?(\".gem\") }'"
  )
}
